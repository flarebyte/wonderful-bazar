'use strict'
magma_agreement = require('magma-agreement')
CT = require('magma-constant')
should = require('should')
_ = require('lodash')

###
======== A Handy Little Mocha Reference ========
https://github.com/visionmedia/should.js
https://github.com/visionmedia/mocha
###

signatory1=
  userId: CT.EX_USER_ID
  roleId: CT.EX_ROLE_ID
  email: "baudelaire@gmail.com"
  accepted: CT.EX_ISO_DATETIME
  terminated: null

term1=
  subjectId: CT.EX_USER_ID
  predicatedId: CT.EX_PREDICATE_ID
  value: CT.EX_ZONE_ID

validAgreement =
  id: CT.EX_AGREEMENT_ID
  name: "my agreement"
  created: CT.EX_ISO_DATETIME
  modified: CT.EX_ISO_DATETIME
  submitted: CT.EX_ISO_DATETIME
  accepted: CT.EX_ISO_DATETIME
  terminated: CT.EX_ISO_DATETIME
  creator: CT.EX_USER_ID
  replaces: CT.EX_AGREEMENT_ID
  signatories: [signatory1,signatory1]
  terms: [term1,term1]


describe "magma-agreement", ->
  describe "#validateAgreement()", ->
    it "accepts valid agreement", (done)->
      magma_agreement.validateAgreement validAgreement, (e, res) ->
        if e
          done(e)
        else
          res.should.be.ok
          done()

    it "refuses invalid agreement", (done)->
      sp = _.cloneDeep(validAgreement)
      sp.id = "myagreement123456"
      magma_agreement.validateAgreement sp, (e, res) ->
        if e
          msg = e.message
          E4757193 = "E4757193: valid agreement ID required, not #{sp.id}!"
          msg.should.equal [E4757193].toString()
          done()
        else
          res.should.be.false
          done()

  describe "#safeCopyAgreement()", ->
    it "copies agreement", (done)->
      sp = _.cloneDeep(validAgreement)
      sp.hack = "my hack"
      cp=magma_agreement.safeCopyAgreement(sp)
      cp.should.eql(validAgreement)
      done()

